apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: sessions-xp
  namespace: default
spec:
  components:
    # DynamoDB table for storing sessions (Crossplane) with TTL and streams
    # Note: Component name becomes the Kubernetes resource name and AWS table name
    - name: tenant-atlantis-sessions-xp
      type: aws-dynamodb-xp
      properties:
        region: us-west-2
        attributeDefinitions:
          - attributeName: sessionId
            attributeType: "S"
        keySchema:
          - attributeName: sessionId
            keyType: HASH
        billingMode: PAY_PER_REQUEST
      traits:
        - type: dynamodb-ttl-xp
          properties:
            attributeName: expiresAt
        - type: dynamodb-streams-xp
          properties:
            viewType: KEYS_ONLY

    # Session API application (uses tenant-atlantis-sessions-xp table via Crossplane)
    - name: sessions-api-xp
      type: webservice
      properties:
        image: session-api:latest
        imagePullPolicy: IfNotPresent
        ports:
          - port: 8080
            expose: true
        env:
          - name: DYNAMODB_TABLE_NAME
            value: "tenant-atlantis-sessions-xp"
          - name: AWS_REGION
            value: "us-west-2"
          - name: SESSION_TTL_HOURS
            value: "24"
          - name: PORT
            value: "8080"
          - name: AWS_SHARED_CREDENTIALS_FILE
            value: "/aws/credentials"
        volumeMounts:
          secret:
            - name: aws-creds-xp
              mountPath: /aws
              secretName: aws-credentials-xp
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
      traits:
        - type: scaler
          properties:
            replicas: 2
        - type: resource
          properties:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
