apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: simpledynamodb-localstack
spec:
  schema:
    apiVersion: v1alpha1
    kind: SimpleDynamoDBLocalStack
    spec:
      tableName: string
      region: string
    status:
      tableState: string

  resources:
    - id: dynamodb-table
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: dynamodb-table-${schema.spec.tableName}
          annotations:
            localstack/table-name: ${schema.spec.tableName}
            localstack/region: ${schema.spec.region}
        data:
          table-name: ${schema.spec.tableName}
          region: ${schema.spec.region}
          creation-script: |
            #!/bin/bash
            aws dynamodb create-table \
              --table-name ${schema.spec.tableName} \
              --attribute-definitions AttributeName=id,AttributeType=S \
              --key-schema AttributeName=id,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --endpoint-url http://localstack.localstack-system.svc.cluster.local:4566 \
              --region ${schema.spec.region}

    - id: table-creator-job
      template:
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: create-${schema.spec.tableName}
        spec:
          ttlSecondsAfterFinished: 3600
          template:
            spec:
              containers:
              - name: aws-cli
                image: amazon/aws-cli:latest
                env:
                - name: AWS_ACCESS_KEY_ID
                  value: "test"
                - name: AWS_SECRET_ACCESS_KEY
                  value: "test"
                - name: AWS_DEFAULT_REGION
                  value: ${schema.spec.region}
                command:
                - /bin/sh
                - -c
                - |
                  aws dynamodb create-table \
                    --table-name ${schema.spec.tableName} \
                    --attribute-definitions AttributeName=id,AttributeType=S \
                    --key-schema AttributeName=id,KeyType=HASH \
                    --billing-mode PAY_PER_REQUEST \
                    --endpoint-url http://localstack.localstack-system.svc.cluster.local:4566 \
                    --region ${schema.spec.region} && \
                  echo "Table created successfully" || \
                  (aws dynamodb describe-table --table-name ${schema.spec.tableName} \
                    --endpoint-url http://localstack.localstack-system.svc.cluster.local:4566 \
                    --region ${schema.spec.region} && echo "Table already exists")
              restartPolicy: Never
          backoffLimit: 3
